/**
 * created 09/04/2015
 * 
 * @author marcus
 * @see http://livedocs.dojotoolkit.org/util/doh
 * @description TODO: fill in description
 * 
 * @generated by TemplateWizard, v.2015/07/16 //do not remove this comment please
 */
define([
	"doh",
	"dojo/has",
	"dojo/Deferred",
	"dojo/promise/Promise",
	"dojo/_base/array",

	// tested libraries
	"dojo/promise/all",
	"gjax/promise/all"
], function(doh, has, Deferred, Promise, array, all, _all) {

	// ---------------------------- test object ------------------
	// private functions

	// test object
	var testObject = {
		"returns Promise" : function() {
			doh.t(all([]) instanceof Promise);
			doh.t(_all([]) instanceof Promise);
			doh.t(_all({}) instanceof Promise);
		},
		"dojo/promise/all DOES NOT HAVE map function" : function() {
			doh.f("map" in all([]));
		},
		"gjax/promise/all HAS map function (array)" : function() {
			doh.is("function", typeof _all([]).map);
		},
		"gjax/promise/all DOES NOT HAVE map function (object)" : function() {
			doh.f("map" in all([]));
		},
		"map works on values" : function() {
			return _all([
				1,
				p(2, 100),
				3
			]).map(function(v) { //sample transform
				return v * 2;
			}).then(function(values) {
				doh.is([
					2,
					4,
					6
				], values);
			});
		},
		"map does not get called on failing promises" : function() {
			return _all([
				1,
				f(2, 100),
				3
			]).map(function(v) { //sample transform
				doh.t(false, "unexpected success" + v);
				return v;
			}).then(function(values) {
				doh.t(false, "unexpected success" + values);
			}, function() {
				doh.t(true, "expected failure");
			});
		},
		"failing map propagates error" : function() {
			var r = new Deferred();
			_all([
				1,
				p(2, 100),
				3
			]).map(function(v) { //sample transform
				throw new Error("test error" + v);
			}).then(function(values) {
				doh.t(false, "unexpected success" + values);
			}).otherwise(function() {
				r.resolve();
			});
			return r;
		},
		"gjax/promise/all HAS filter function (array)" : function() {
			doh.is("function", typeof _all([]).filter);
		},
		"gjax/promise/all DOES NOT HAVE filter function (object)" : function() {
			doh.f("filter" in all([]));
		},
		"filter works on values" : function() {
			return _all([
				1,
				p(2, 100),
				3
			]).filter(function(v) { //sample filter
				return v <= 2;
			}).then(function(values) {
				doh.is([
					1,
					2
				], values);
			});
		},
		"gjax/promise/all HAS forEach function (array)" : function() {
			doh.is("function", typeof _all([]).forEach);
		},
		"gjax/promise/all DOES NOT HAVE forEach function (object)" : function() {
			doh.f("forEach" in all([]));
		},
		"forEach works on values" : function() {
			var count = 0;
			return _all([
				1,
				p(2, 100),
				3
			]).forEach(function(v) {
				count += v;
			}).then(function(values) {
				doh.t(values === undefined); // forEach does not return array
				doh.is(6, count);
			});
		},
		"chaining - return from map() has filter function() etc..." : function() {

			var mapped = _all([
				1,
				p(2, 100),
				3
			]).map(function(v) {
				return v;
			});
			doh.t(mapped instanceof Promise);
			doh.t("filter" in mapped, "shall be decorated");

			// you can use chaining then
			_all([
				1,
				p(2, 100),
				3
			]).map(function(v) {
				return v;
			}).filter(function(v) {
				return v <= 2;
			}).map(function(v) {
				return v * 2;
			}).then(function(v) {
				doh.is([
					2,
					4
				], v);
			});
		}
	};

	doh.register("promise", testObject);

	doh.register("promise-POCs", {
		"POC: promise is frozen and connot be extended" : function() {
			var p = all([]);
			p.map = function() {
			};
			doh.f("map" in p);
		}
	});

	// runnable with: node (dnode)
	has("host-browser") || doh.run();

	function p(value, time) {
		var r = new Deferred();
		setTimeout(function() {
			r.resolve(value);
		}, time);
		return r;
	}
	function f(value, time) {
		var r = new Deferred();
		setTimeout(function() {
			r.reject(new Error("Rejected:" + value));
		}, time);
		return r;
	}
});
